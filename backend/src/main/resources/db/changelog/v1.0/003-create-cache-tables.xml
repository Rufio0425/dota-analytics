<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Create cache metadata table for tracking cache status -->
    <changeSet id="003-01-create-cache-metadata-table" author="claude">
        <createTable tableName="cache_metadata">
            <column name="id" type="uuid" defaultValueComputed="uuid_generate_v4()">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cache_key" type="varchar(100)">
                <constraints unique="true" nullable="false"/>
            </column>
            <column name="cache_type" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="is_valid" type="boolean" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Create indexes for cache lookups -->
        <createIndex tableName="cache_metadata" indexName="idx_cache_metadata_cache_key">
            <column name="cache_key"/>
        </createIndex>

        <createIndex tableName="cache_metadata" indexName="idx_cache_metadata_cache_type">
            <column name="cache_type"/>
        </createIndex>

        <createIndex tableName="cache_metadata" indexName="idx_cache_metadata_expires_at">
            <column name="expires_at"/>
        </createIndex>

        <rollback>
            <dropTable tableName="cache_metadata"/>
        </rollback>
    </changeSet>

    <!-- Add trigger to update cache metadata -->
    <changeSet id="003-02-create-cache-metadata-update-timestamp-trigger" author="claude">
        <sql>
            CREATE TRIGGER update_cache_metadata_updated_at 
                BEFORE UPDATE ON cache_metadata 
                FOR EACH ROW 
                EXECUTE FUNCTION update_updated_at_column();
        </sql>
        <rollback>
            DROP TRIGGER IF EXISTS update_cache_metadata_updated_at ON cache_metadata;
        </rollback>
    </changeSet>

</databaseChangeLog>